#!/bin/bash

# Change to project root directory (where .ddev is located)
cd "$( dirname "${BASH_SOURCE[0]}" )/../../.."

echo "ğŸ”„ Starting PressX Update Process..."

# Update Composer dependencies first
echo "ğŸ“¦ Updating Composer dependencies..."
ddev composer update

# Check WordPress core updates (only if not managed by Composer)
if ! grep -q "\"wordpress/wordpress\":" composer.json 2>/dev/null; then
    echo "ğŸ“¦ Checking WordPress core updates..."
    ddev exec -d /var/www/html/public_html wp core check-update
    if [ $? -eq 0 ]; then
        echo "â¬†ï¸  Updating WordPress core..."
        ddev exec -d /var/www/html/public_html wp core update
        ddev exec -d /var/www/html/public_html wp core update-db
    fi
fi

# Update only non-Composer managed plugins, excluding Hello Dolly
echo "ğŸ”Œ Updating non-Composer managed plugins..."
ddev exec -d /var/www/html/public_html 'wp plugin list --field=name --status=active | while read plugin; do
    # Skip Hello Dolly and Composer-managed plugins
    if [[ "$plugin" != "hello" ]] && ! grep -q "\"$plugin\":" ../composer.json 2>/dev/null; then
        wp plugin update "$plugin"
    fi
done'

# Update database if needed
echo "ğŸ—„ï¸  Checking database updates..."
ddev exec -d /var/www/html/public_html wp core update-db

# Clear all caches
echo "ğŸ§¹ Clearing caches..."
ddev exec -d /var/www/html/public_html wp cache flush

# Display current versions
echo -e "\nğŸ“Š Current System Status:"
echo "----------------------------------------"
echo "WordPress Core:"
ddev exec -d /var/www/html/public_html wp core version
echo -e "\nComposer Status:"
ddev composer show
echo -e "\nActive Plugins:"
ddev exec -d /var/www/html/public_html wp plugin list --status=active

echo -e "\nâœ… Update process complete!"
