#!/bin/bash

# Ensure we're in the docroot
cd "${DDEV_APPROOT}/public_html"

# Download WordPress if it's not already present
if [ ! -f wp-config.php ]; then
    echo "Downloading WordPress..."
    ddev exec -d /var/www/html/public_html wp core download
fi

# Generate wp-config.php if it doesn't exist
if [ ! -f wp-config.php ]; then
    echo "Creating wp-config.php..."
    ddev exec -d /var/www/html/public_html wp config create \
        --dbname=db \
        --dbuser=db \
        --dbpass=db \
        --dbhost=db
fi

# Install WordPress if not already installed
if ! $(ddev exec -d /var/www/html/public_html wp core is-installed); then
    echo "Installing WordPress..."
    ddev exec -d /var/www/html/public_html wp core install \
        --url='${DDEV_PRIMARY_URL}' \
        --title='PressX' \
        --admin_user=admin \
        --admin_password=admin \
        --admin_email=admin@example.com

    echo "WordPress installed successfully!"
    echo "Admin URL: ${DDEV_PRIMARY_URL}/wp-admin"
    echo "Username: admin"
    echo "Password: admin"
else
    echo "WordPress is already installed."
fi

# Install and activate required plugins
echo "Installing and activating required plugins..."
ddev exec -d /var/www/html/public_html wp plugin install wp-graphql --activate
ddev exec -d /var/www/html/public_html wp plugin install classic-editor --activate
ddev exec -d /var/www/html/public_html wp plugin install headless-mode --activate

# Configure Classic Editor settings
ddev exec -d /var/www/html/public_html wp option update classic-editor-replace replace
ddev exec -d /var/www/html/public_html wp option update classic-editor-allow-sites disallow

# Configure Headless Mode settings
ddev exec -d /var/www/html/public_html wp option update headless_mode_enabled 1
ddev exec -d /var/www/html/public_html wp option update headless_mode_frontend_url "https://pressx-nextjs.ddev.site:3333"
ddev exec -d /var/www/html/public_html wp option update headless_mode_enable_preview 1
ddev exec -d /var/www/html/public_html wp option update headless_mode_redirect_frontend 1
ddev exec -d /var/www/html/public_html wp option update headless_mode_redirect_admin_ajax 0
ddev exec -d /var/www/html/public_html wp option update headless_mode_redirect_rest_api 0
ddev exec -d /var/www/html/public_html wp option update headless_mode_disable_theme 1

# Verify endpoints are accessible
echo "GraphQL endpoint available at: ${DDEV_PRIMARY_URL}/graphql"
echo "Next.js frontend configured at: https://pressx-nextjs.ddev.site"

