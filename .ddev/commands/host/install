#!/bin/bash

# Create necessary directories
echo "Creating necessary directories..."
mkdir -p public_html/wp-content/{uploads,plugins/pressx-core}
chmod -R 777 public_html/wp-content/uploads

# Download WordPress core if not present
if [ ! -f public_html/wp-config.php ]; then
    echo "Downloading WordPress..."
    ddev exec -d /var/www/html/public_html wp core download

    echo "Creating wp-config.php..."
    ddev exec -d /var/www/html/public_html wp config create \
        --dbname=db \
        --dbuser=db \
        --dbpass=db \
        --dbhost=db \
        --extra-php <<PHP
define( 'PRESSX_FRONTEND_URL', 'http://localhost:3333' );
define( 'WORDPRESS_PREVIEW_SECRET', 'pressx_preview_secret' );
PHP
fi

# Install dependencies with Composer
echo "Installing dependencies with Composer..."
ddev composer install

# Install WordPress if not already installed
if ! $(ddev exec -d /var/www/html/public_html wp core is-installed); then
    echo "Installing WordPress..."
    ddev exec -d /var/www/html/public_html wp core install \
        --url='${DDEV_PRIMARY_URL}' \
        --title='PressX' \
        --admin_user=admin \
        --admin_password=admin \
        --admin_email=admin@example.com

    echo "WordPress installed successfully!"
    echo "Admin URL: ${DDEV_PRIMARY_URL}/wp-admin"
    echo "Username: admin"
    echo "Password: admin"
else
    echo "WordPress is already installed."
fi

# Configure WordPress settings
echo "Configuring WordPress settings..."

# Configure Classic Editor settings
ddev exec -d /var/www/html/public_html wp option update classic-editor-replace replace
ddev exec -d /var/www/html/public_html wp option update classic-editor-allow-sites disallow

# Set up permalink structure
echo "Setting up permalink structure..."
ddev exec -d /var/www/html/public_html wp rewrite structure '/%postname%/'
ddev exec -d /var/www/html/public_html wp rewrite flush

# Verify setup
echo "GraphQL endpoint available at: ${DDEV_PRIMARY_URL}/graphql"
echo "Next.js frontend configured at: http://localhost:3333"
echo "Verifying plugin status..."
ddev exec -d /var/www/html/public_html wp plugin list

